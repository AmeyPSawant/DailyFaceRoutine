<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Skincare Routine</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to bottom, #fefcea, #f1da36);
      margin: 0;
      padding: 20px;
      color: #333;
    }

    .title-container {
      display: flex;
      align-items: center;
      text-align: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 20px;
    }

    .title-emoji {
      font-size: 2em;
    }

    .title-text {
      font-size: 1.5em;
      font-weight: bold;
    }

    .custom-select-wrapper {
      position: relative;
      display: inline-block;
    }

    #day-selector {
      font-size: 1.2em;
      font-weight: bold;
      color: white;
      background-color: rgba(0, 0, 0, 0.6); /* Faded black box */
      padding: 10px 40px 10px 15px;
      border: 1px solid #555;
      border-radius: 8px;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      cursor: pointer;
    }

    h2 {
      margin-top: 40px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ccc;
    }

    .routine {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin: 20px 0;
    }

    .step {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
    }

    input[type="checkbox"] {
      width: 20px;
      height: 20px;
    }

    .am {
      background: linear-gradient(to right, #ffffff, #d4edff);
      padding: 20px;
      border-radius: 10px;
    }

    .pm {
      background: linear-gradient(to right, #1a1a2e, #3f0071);
      color: white;
      padding: 20px;
      border-radius: 10px;
    }

    #overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: none;
      align-items: center;
      justify-content: center;
      flex-direction: column; /* Stack content vertically */
      z-index: 9999;
      text-align: center;
      font-size: 2em;
    }

    #overlay .timer-text {
      margin: 0;
    }

    #overlay .timer-countdown {
      font-size: 4em; /* Makes the timer significantly larger */
      font-weight: bold;
      margin-top: 10px;
    }

    .close-overlay {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 2em;
      color: inherit; /* Inherits color from #overlay.am or #overlay.pm */
      cursor: pointer;
      line-height: 1;
      font-weight: bold;
    }

    #overlay.am {
      background: rgba(255, 255, 255, 0.8);
      color: #000;
    }

    #overlay.pm {
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
    }
  </style>
</head>
<body>
  <div class="title-container">
    <span class="title-emoji">üß¥</span>
    <div class="custom-select-wrapper">
      <select id="day-selector"></select>
    </div>
  </div>
  <div id="am-routine" class="am">
    <h3>‚òÄÔ∏è AM Routine</h3>
    <div class="routine" id="am-steps"></div>
  </div>

  <div id="pm-routine" class="pm">
    <h3>üåô PM Routine</h3>
    <div class="routine" id="pm-steps"></div>
  </div>

  <div id="overlay"></div>

  <script>
    // === Global State & Configuration ===
    let routineData = [];
    let timers = new Map();
    let currentInterval = null; // To manage the timer interval globally

    // The ID of your Google Sheet.
    const sheetId = "1bnIeueU-AkhRVe6xbQBG7cxdIg8Q7IIhGRl_qBOk6qY";

    // Sheet 1: Routines (First row = AM/PM headers, First column = days)
    // Sheet 2: Timers (First column = Product, Second column = Wait time in seconds)

    async function fetchSheetData(sheetName) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${sheetName}`;
      try {
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Network response was not ok (${response.status})`);
        }
        const text = await response.text();
        // The response is JSONP. We need to extract the JSON part.
        const jsonpData = text.substring(text.indexOf('(') + 1, text.lastIndexOf(')'));
        if (!jsonpData) throw new Error("Invalid JSONP response format from Google Sheets.");

        const json = JSON.parse(jsonpData);
        if (json.status === 'error') throw new Error(`Google Sheets API Error: ${json.errors[0].detailed_message}`);

        const rows = json.table.rows;
        return rows ? rows.map(row => row.c.map(cell => cell?.v || "")) : [];
      } catch (error) {
        console.error(`Failed to fetch or parse data for sheet "${sheetName}":`, error);
        throw error; // Re-throw the error to be caught by the caller
      }
    }

    function getCurrentDay() {
      return new Date().toLocaleDateString("en-US", { weekday: 'short' });
    }

    function getTodayDateString() {
      return new Date().toISOString().split('T')[0]; // YYYY-MM-DD format
    }

    function hideOverlay() {
      if (currentInterval) clearInterval(currentInterval);
      const overlay = document.getElementById("overlay");
      overlay.style.display = "none";
      overlay.innerHTML = ''; // Clean up for next time

      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => cb.disabled = false);
    }

    function showOverlay(type, waitTime, step) {
      const overlay = document.getElementById("overlay");
      overlay.className = type;
      overlay.innerHTML = `
        <span class="close-overlay">&times;</span>
        <div>
          <p class="timer-text">${step} Applied</p>
          <p class="timer-text">Please wait</p>
          <span class="timer-countdown">${waitTime}s</span>
        </div>
      `;
      overlay.style.display = "flex";

      overlay.querySelector('.close-overlay').addEventListener('click', hideOverlay);

      const checkboxes = document.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => cb.disabled = true);

      let counter = waitTime;
      const countdownElement = overlay.querySelector('.timer-countdown');

      if (currentInterval) clearInterval(currentInterval);

      currentInterval = setInterval(() => {
        counter--;
        if (countdownElement) {
          countdownElement.textContent = `${counter}s`;
        }
        if (counter <= 0) {
          hideOverlay();
        }
      }, 1000);
    }

    function saveState() {
      const state = {};
      const checkboxes = document.querySelectorAll('.routine input[type="checkbox"]');
      checkboxes.forEach(cb => {
        state[cb.id] = cb.checked;
      });
      localStorage.setItem('checkboxState', JSON.stringify(state));
      localStorage.setItem('lastVisitDate', getTodayDateString());
    }

    function loadState() {
      const savedDate = localStorage.getItem('lastVisitDate');
      if (savedDate !== getTodayDateString()) {
        localStorage.removeItem('checkboxState');
        return;
      }

      const state = JSON.parse(localStorage.getItem('checkboxState') || '{}');
      Object.keys(state).forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) {
          checkbox.checked = state[id];
        }
      });
    }

    function createRoutineList(steps, containerId, type, timers) {
      const container = document.getElementById(containerId);
      steps.forEach((step, idx) => {
        const stepId = `${type}-${step.replace(/\s+/g, '-')}-${idx}`;

        const div = document.createElement("div");
        div.className = "step";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.id = stepId;

        const label = document.createElement("label");
        label.htmlFor = stepId;
        label.textContent = step;

        checkbox.addEventListener("change", () => {
          saveState(); // Save state on every change
          const waitTime = timers.get(step);
          if (checkbox.checked && waitTime) {
            showOverlay(type, waitTime, step);
          }
        });

        div.appendChild(checkbox);
        div.appendChild(label);
        container.appendChild(div);
      });
    }

    function renderRoutineForDay(day) {
      document.getElementById('am-steps').innerHTML = '';
      document.getElementById('pm-steps').innerHTML = '';

      if (routineData.length === 0) {
        console.error("Routine data is not loaded.");
        return;
      }

      const headers = routineData[0];
      const dayIndex = { Sun: 0, Mon: 1, Tue: 2, Wed: 3, Thu: 4, Fri: 5, Sat: 6 }[day];
      if (dayIndex === undefined || !routineData[dayIndex + 1]) {
        console.warn(`Could not find routine data for today: ${day}.`);
        return;
      }
      const todayData = routineData[dayIndex + 1];

      const pmHeaderIndex = headers.indexOf("PM");
      if (pmHeaderIndex === -1) {
        console.error("Could not find 'PM' header in the Routines sheet.");
        return;
      }

      const amSteps = todayData.slice(1, pmHeaderIndex).filter(step => step);
      const pmSteps = todayData.slice(pmHeaderIndex + 1).filter(step => step);

      createRoutineList(amSteps, "am-steps", "am", timers);
      createRoutineList(pmSteps, "pm-steps", "pm", timers);

      loadState();
    }

    function setupDaySelector() {
      const selector = document.getElementById('day-selector');
      const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      days.forEach(day => {
        const option = document.createElement('option');
        option.value = day;
        option.textContent = `${day} Routine`;
        selector.appendChild(option);
      });

      selector.value = getCurrentDay();

      selector.addEventListener('change', (e) => {
        renderRoutineForDay(e.target.value);
      });
    }

    async function init() {
      try {
        const [fetchedRoutineData, fetchedTimerData] = await Promise.all([
          fetchSheetData("Routine"),
          fetchSheetData("Timer")
        ]);

        routineData = fetchedRoutineData;
        timers = new Map(fetchedTimerData.map(([product, time]) => [product.trim(), parseInt(time, 10)]));

        setupDaySelector();
        renderRoutineForDay(getCurrentDay());

      } catch (error) {
        console.error("Failed to initialize the application:", error);
        const amContainer = document.getElementById('am-routine');
        const pmContainer = document.getElementById('pm-routine');
        if (pmContainer) pmContainer.style.display = 'none';

        let errorDetails = `<p><strong>Details:</strong> ${error.message}</p>`;
        if (error instanceof TypeError && error.message.includes('Failed to fetch')) {
          errorDetails += `<p>This may be a network or CORS issue. Please check your internet connection and the browser's developer console (F12) for more information.</p>`;
        } else {
          errorDetails += `<p>Please ensure your Google Sheet is shared with "Anyone with the link can view" and that the sheet names ("Routine", "Timer") are correct.</p>`;
        }

        if (amContainer) {
          amContainer.innerHTML = `
            <h3 style="color: #d9534f;">‚ùå Error Loading Routine</h3>
            ${errorDetails}
            `;
        }
      }
    }

    init();
  </script>
</body>
</html>
